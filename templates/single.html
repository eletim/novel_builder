{% extends "base.html" %}
{% set title = chapter_name ~ " / " ~ label %}

{% block header_right %}
<div class="actions">
  <a class="btn" href="{{ url_for('chapter', chapter_path=chapter_path) }}">一覧表示</a>
  <button id="saveBtn" class="btn">💾 保存（Ctrl+S）</button>
</div>
{% endblock %}
{% block content %}
<!-- <h1>{{ chapter_name }}</h1>
<p class="muted">{{ chapter_path }} / <strong>{{ label }}</strong> <span class="file">{{ filename }}</span></p> -->

<div class="single-rows">
  <!-- 上：前章 -->
  <div class="vnav vnav-top">
    <a class="nav-arrow" aria-label="前の章へ (↑)"
       href="{{ url_for('chapter_single', chapter_path=prev_chapter) }}?stage={{ filename }}">
      <svg class="icon" aria-hidden="true"><use href="#i-chevron-up"></use></svg>
      <span class="sr-only">前の章</span>
    </a>
  </div>

  <!-- 中央：左(15%)＋本文(70%)＋右(15%) -->
  <div class="single-middle">
    <!-- 左：前ステージ -->
    <div class="side side-left">
      <a class="nav-arrow" aria-label="前ステージ (←)"
         href="{{ url_for('chapter_single', chapter_path=chapter_path) }}?stage={{ prev_stage }}">
        <svg class="icon" aria-hidden="true"><use href="#i-chevron-left"></use></svg>
        <span class="sr-only">前ステージ</span>
      </a>
    </div>

    <!-- 本文 70% -->
    <section class="pane" id="singlePane" data-chapter="{{ chapter_path }}" data-filename="{{ filename }}">
      <header class="pane-head">
        <div class="pane-title">
          <strong>{{ chapter_name }}</strong>
          <span>-</spap>
          <strong>{{ label }}</strong>
          <span class="file">{{ filename }}</span>
          <span class="dirty" hidden>●未保存</span>
        </div>
        <div class="pane-tools">
          <span class="counter" aria-live="polite" title="改行は文字数に含めません">
            <span id="charCount">0</span> 文字・<span id="lineCount">0</span> 行
          </span>
          <button class="btn" id="saveBtn2">保存</button>
        </div>
      </header>
      <textarea class="editor" id="singleEditor" spellcheck="false" wrap="soft">{{ content }}</textarea>
    </section>

    <!-- 右：次ステージ -->
    <div class="side side-right">
      <a class="nav-arrow" aria-label="次ステージ (→)"
         href="{{ url_for('chapter_single', chapter_path=chapter_path) }}?stage={{ next_stage }}">
        <svg class="icon" aria-hidden="true"><use href="#i-chevron-right"></use></svg>
        <span class="sr-only">次ステージ</span>
      </a>
    </div>
  </div>

  <!-- 下：次章 -->
  <div class="vnav vnav-bottom">
    <a class="nav-arrow" aria-label="次の章へ (↓)"
       href="{{ url_for('chapter_single', chapter_path=next_chapter) }}?stage={{ filename }}">
      <svg class="icon" aria-hidden="true"><use href="#i-chevron-down"></use></svg>
      <span class="sr-only">次の章</span>
    </a>
  </div>
</div>

<div id="toast" class="toast" hidden></div>
{% endblock %}

{% block scripts %}
<script>
  // キーボードナビ（既存仕様：左右=ステージ、上下=章）
  window.__SINGLE__ = {
    prevStageUrl: "{{ url_for('chapter_single', chapter_path=chapter_path) }}?stage={{ prev_stage }}",
    nextStageUrl: "{{ url_for('chapter_single', chapter_path=chapter_path) }}?stage={{ next_stage }}",
    prevChapterUrl: "{{ url_for('chapter_single', chapter_path=prev_chapter) }}?stage={{ filename }}",
    nextChapterUrl: "{{ url_for('chapter_single', chapter_path=next_chapter) }}?stage={{ filename }}"
  };
</script>
{% endblock %}
